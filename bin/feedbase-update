#!/usr/bin/env node
var feedbase = require("../lib/feedbase.js")
var util = require("../lib/util.js")
var wait = require("../lib/wait.js")
var web3 = require("../lib/web3.js")

var [id, value, expiration] = process.argv.slice(2)

if (!/^0x[0-9a-f]{64}$/.test(value)) {
  console.error(`error: bad value: ${value}`)
  process.exit(1)
}

console.log(`update`)
console.log(`id          ${id}`)
console.log(`value       ${value}`)
console.log(`expiration  ${expiration}`)

wait(x => {
  return x == id
    && util.toBytes32(feedbase.readExpired.call(id)) == value
    && feedbase.getExpiration(id) == expiration
}, id => {
  console.log("ok")
}, () => {
  console.error("error: failed to update feed (operation timed out)")
  process.exit(1)
})

feedbase.update(id, value, expiration)
